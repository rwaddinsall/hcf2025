---
// src/pages/applications.astro
import InfoPageLayout from '../components/InfoPageLayout.astro';
import { getApplicationsPage } from '../utils/static-content';
import { renderSafeContent } from '../utils/renderContent';

// Get applications page data from static content
const applicationsPageData = getApplicationsPage();

const pageTitle = applicationsPageData?.Header?.title;
const pageSubtitle = applicationsPageData?.Header?.subheading;
const bodyContent = applicationsPageData?.Body?.Content;

const accordionSections = applicationsPageData?.FAQ?.flatMap(section =>
  (section.accordions || []).map(accordion => {
    // Handle the deadline formatting
    let deadlineText = '';
    if (accordion.deadline) {
      const deadlineDate = new Date(accordion.deadline);
      deadlineText = deadlineDate.toLocaleDateString('en-AU', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Build the details content with form button and deadline
    let fullDetails = renderSafeContent(accordion.details);

    // Add form button if not closed and has form URL
    if (!accordion.is_closed && accordion.form_url) {
      fullDetails += `
        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <a href="${accordion.form_url}"
             target="_blank"
             rel="noopener noreferrer"
             class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
            üìù Submit Application
          </a>
        </div>
      `;
    }

    // Add deadline if exists
    if (deadlineText) {
      fullDetails += `
        <div class="mt-4 p-4 border border-red-200 rounded-lg bg-red-50">
          <p class="text-red-800">
            <strong>Deadline:</strong> ${deadlineText}
          </p>
        </div>
      `;
    }

    // Add closed message if closed
    if (accordion.is_closed && accordion.closed_message) {
      fullDetails += `
        <div class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
          ${renderSafeContent(accordion.closed_message)}
        </div>
      `;
    }

    return {
      title: accordion.title,
      details: fullDetails,
      category: accordion.category
    };
  })
) || [];
---

<InfoPageLayout
  slug="applications"
  fallbackHeading="Applications"
  fallbackSubheading={pageSubtitle}
  fallbackAccordion={accordionSections}
>
  {bodyContent && (
    <div class="mt-8 prose prose-lg max-w-none">
      <Fragment set:html={renderSafeContent(bodyContent)} />
    </div>
  )}

  <div class="mt-8 p-4 border border-blue-200 rounded-lg bg-blue-50">
    <p class="text-blue-800">
      <strong>Questions?</strong> For all application enquiries, contact us at
      <a href="mailto:info@hopkins-creek.com" class="underline">info@hopkins-creek.com</a>
    </p>
  </div>
</InfoPageLayout>